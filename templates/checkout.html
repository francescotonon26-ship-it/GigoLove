<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Checkout - GigoLove</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">

{% if shake_enabled %}
<style>
    /* Permission Button - MUST CLICK FIRST */
    #permissionButton {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #d4af37, #FFD700);
        color: #000;
        padding: 20px 40px;
        border-radius: 15px;
        border: none;
        font-size: 1.3rem;
        font-weight: 700;
        box-shadow: 0 10px 30px rgba(255, 215, 0, 0.6);
        z-index: 10001;
        cursor: pointer;
        animation: pulse 2s infinite;
        display: block;
    }

    #permissionButton.hidden {
        display: none;
    }

    @keyframes pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.05); }
    }

    /* Overlay Backdrop */
    #permissionBackdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
    }

    #permissionBackdrop.hidden {
        display: none;
    }

    #permissionText {
        color: #FFD700;
        font-size: 1.5rem;
        font-weight: 700;
        text-align: center;
        max-width: 80%;
    }

    /* Audio Player Overlay */
    #audioOverlay {
        display: none;
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        border: 3px solid #FFD700;
        border-radius: 20px;
        padding: 25px 30px;
        box-shadow: 0 10px 40px rgba(255, 215, 0, 0.7);
        z-index: 10000;
        min-width: 300px;
        animation: slideUp 0.5s ease-out;
    }

    #audioOverlay.show {
        display: block;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(100px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    #audioIcon {
        font-size: 4rem;
        text-align: center;
        animation: spin 3s linear infinite;
        margin-bottom: 15px;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    #audioText {
        color: #FFD700;
        font-size: 1.3rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 15px;
    }

    #audioSubtext {
        color: #ccc;
        font-size: 0.9rem;
        text-align: center;
    }

    #closeAudioBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        color: #FFD700;
        font-size: 1.5rem;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Shake Indicator */
    #shakeIndicator {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 215, 0, 0.2);
        border: 2px solid #FFD700;
        color: #FFD700;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 700;
        z-index: 9999;
        animation: blink 1.5s infinite;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    #shakeIndicator.hidden {
        display: none;
    }
</style>
{% endif %}
</head>

<body class="bg-black text-white">

{% if shake_enabled %}
<!-- Permission Backdrop -->
<div id="permissionBackdrop">
<div id="permissionText">
        üéµ Messaggio Segreto Nascosto!<br>
        <small style="font-size: 1rem;">Clicca per attivare il rilevamento shake</small>
</div>
<button id="permissionButton">
        üì± ATTIVA SHAKE
</button>
</div>

<!-- Shake Indicator -->
<div id="shakeIndicator">
    üîä Shake attivo - Scuoti il telefono!
</div>

<!-- Audio Element -->
<audio id="fraAudio" preload="auto">
<source src="{{ url_for('static', filename='audio/audio_serata_fra.mp3') }}" type="audio/mpeg">
</audio>

<!-- Audio Player Overlay -->
<div id="audioOverlay">
<button id="closeAudioBtn">√ó</button>
<div id="audioIcon">üéµ</div>
<div id="audioText">Messaggio da Fra</div>
<div id="audioSubtext">L'audio sta partendo...</div>
</div>
{% endif %}

<div class="container py-5">
<h1 class="luxury-text text-center mb-4">üõí Il tuo Carrello</h1>
        
        {% if prodotti %}
            {% for p in prodotti %}
<div class="checkout-item">
<img src="{{ url_for('static', filename=p.foto) }}" alt="{{ p.nome }}">
<div class="flex-grow-1">
<h5 class="mb-0">{{ p.nome }}</h5>
<small class="text-gold">{{ p.prezzo }}‚Ç¨</small>
</div>
</div>
            {% endfor %}

<div class="mt-4 p-3 border-top border-secondary">
<div class="d-flex justify-content-between h4">
<span>Totale:</span>
<span class="text-gold">{{ totale }}‚Ç¨</span>
</div>
                
                {% if messaggio %}
<div class="alert alert-success py-2 mt-2 small">{{ messaggio }}</div>
                {% endif %}
</div>

<form method="POST" class="mt-4">
<div class="input-group">
<input type="text" name="codice_sconto" class="form-control" placeholder="Codice Sconto (es. ALICE20, NERD69...)">
<button class="btn btn-outline-warning" type="submit">Applica</button>
</div>
<small class="text-muted d-block mt-2" style="font-size: 0.75rem;">
                    üí° Suggerimento: Hai trovato gli easter eggs? Potrebbero esserci codici nascosti...
</small>
</form>

<form action="/conferma" method="POST" class="mt-5">
<button type="submit" class="btn btn-gold w-100 py-3 fw-bold">üíé PROCEDI ALL'ORDINE</button>
</form>

<div class="text-center mt-3">
<a href="/svuota" class="text-muted small">üóëÔ∏è Svuota carrello</a>
<span class="mx-2">|</span>
<a href="/" class="text-muted small">‚Üê Continua lo shopping</a>
</div>

        {% else %}
<div class="text-center py-5">
<div style="font-size: 4rem; margin-bottom: 20px;">üõí</div>
<h3 class="text-white mb-3">Il carrello √® vuoto</h3>
<p class="text-muted">Non essere timida! Sfoglia il nostro catalogo premium.</p>
<a href="/" class="btn btn-gold mt-3">‚ú® Esplora i Gigol√≤</a>
</div>
        {% endif %}
</div>

{% if shake_enabled %}
<script>
    console.log("üéµ SHAKE EASTER EGG LOADED!");
    
    const audio = document.getElementById("fraAudio");
    const audioOverlay = document.getElementById("audioOverlay");
    const permissionBackdrop = document.getElementById("permissionBackdrop");
    const permissionButton = document.getElementById("permissionButton");
    const shakeIndicator = document.getElementById("shakeIndicator");
    const closeAudioBtn = document.getElementById("closeAudioBtn");

    let isListening = false;
    let lastShakeTime = 0;
    let shakeCount = 0;

    // Variabili per accelerometro
    let lastX = 0;
    let lastY = 0;
    let lastZ = 0;
    let isFirstReading = true;

    /* ==================== PLAY AUDIO ==================== */
    function playAudio() {
        console.log("üîä PLAYING AUDIO!");
        
        audio.currentTime = 0;
        audio.play()
            .then(() => {
                console.log("‚úÖ Audio started successfully!");
                audioOverlay.classList.add("show");
                
                // Vibrazione
                if (navigator.vibrate) {
                    navigator.vibrate([300, 100, 300, 100, 300]);
                }
            })
            .catch(err => {
                console.error("‚ùå Audio play failed:", err);
                alert("Errore riproduzione audio: " + err.message);
            });
    }

    /* ==================== SHAKE DETECTION ==================== */
    function handleMotionEvent(event) {
        if (!isListening) return;

        const acc = event.accelerationIncludingGravity;
        if (!acc || acc.x === null) {
            console.log("‚ö†Ô∏è No acceleration data");
            return;
        }

        const x = acc.x || 0;
        const y = acc.y || 0;
        const z = acc.z || 0;

        if (isFirstReading) {
            lastX = x;
            lastY = y;
            lastZ = z;
            isFirstReading = false;
            console.log("üìä First reading:", { x, y, z });
            return;
        }

        const deltaX = Math.abs(x - lastX);
        const deltaY = Math.abs(y - lastY);
        const deltaZ = Math.abs(z - lastZ);
        const totalDelta = deltaX + deltaY + deltaZ;

        lastX = x;
        lastY = y;
        lastZ = z;

        // Log OGNI movimento (cos√¨ vedi se funziona)
        if (totalDelta > 5) {
            console.log("üì± Movement detected:", totalDelta.toFixed(2));
        }

        // SHAKE THRESHOLD - abbassato a 12 per essere pi√π sensibile
        const now = Date.now();
        if (totalDelta > 12) {
            shakeCount++;
            console.log("üåü SHAKE DETECTED! Count:", shakeCount, "Delta:", totalDelta.toFixed(2));
            
            // Dopo 2 shake in 1 secondo -> ATTIVA AUDIO
            if (shakeCount >= 2 && now - lastShakeTime < 1000) {
                console.log("üéâüéâüéâ SHAKE THRESHOLD REACHED! PLAYING AUDIO!");
                playAudio();
                shakeCount = 0;
            }
            
            lastShakeTime = now;
        }

        // Reset shake count dopo 1 secondo
        if (now - lastShakeTime > 1000) {
            shakeCount = 0;
        }
    }

    /* ==================== ACTIVATE ON BUTTON CLICK ==================== */
    permissionButton.addEventListener("click", () => {
        console.log("üéØ Button clicked!");
        
        // iOS RICHIEDE CHE LA PERMISSION SIA CHIAMATA DIRETTAMENTE NEL CLICK
        if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
            console.log("üì± iOS - requesting permission NOW");
            
            // CHIAMATA DIRETTA - NON DELEGATA
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    console.log("‚úÖ Permission response:", response);
                    
                    if (response === "granted") {
                        console.log("üéâ PERMISSION GRANTED!");
                        isListening = true;
                        window.addEventListener("devicemotion", handleMotionEvent);
                        permissionBackdrop.classList.add("hidden");
                        console.log("üëÇ Motion listener ACTIVE - SCUOTI IL TELEFONO!");
                    } else {
                        console.error("‚ùå Permission denied");
                        alert("Permesso negato! Ricarica e accetta.");
                    }
                })
                .catch(err => {
                    console.error("‚ùå Permission error:", err);
                    alert("Errore: " + err.message);
                });
        } else {
            // Android o vecchi browser
            console.log("üì± Android/Desktop - no permission needed");
            isListening = true;
            window.addEventListener("devicemotion", handleMotionEvent);
            permissionBackdrop.classList.add("hidden");
            console.log("üëÇ Motion listener ACTIVE - SCUOTI IL TELEFONO!");
        }
    });

    /* ==================== CLOSE AUDIO ==================== */
    closeAudioBtn.addEventListener("click", () => {
        audio.pause();
        audio.currentTime = 0;
        audioOverlay.classList.remove("show");
    });

    audio.addEventListener("ended", () => {
        audioOverlay.classList.remove("show");
    });

    console.log("‚úÖ Script fully loaded - click button to activate!");
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>