<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Checkout - GigoLove</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">

{% if shake_enabled %}
<style>
    #audioOverlay {
        display: none;
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        border: 3px solid #FFD700;
        border-radius: 20px;
        padding: 20px 30px;
        box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6);
        z-index: 10000;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        min-width: 280px;
        animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    #audioIcon {
        font-size: 3rem;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { 
            transform: scale(1); 
            opacity: 0.8; 
        }
        50% { 
            transform: scale(1.2); 
            opacity: 1; 
        }
    }

    #audioText {
        color: #FFD700;
        font-size: 1.2rem;
        font-weight: 700;
        text-align: center;
    }
</style>
{% endif %}
</head>

<body class="bg-black text-white">

{% if shake_enabled %}
<!-- Audio segreto -->
<audio id="fraAudio" preload="auto">
<source src="{{ url_for('static', filename='audio/audio_serata_fra.mp3') }}" type="audio/mpeg">
</audio>

<!-- Overlay audio -->
<div id="audioOverlay">
<div id="audioIcon">üîä</div>
<div id="audioText">Fra √® gi√† in arrivo‚Ä¶</div>
</div>
{% endif %}

<div class="container py-5">
<h1 class="luxury-text text-center mb-4">üõí Il tuo Carrello</h1>
        
        {% if prodotti %}
            {% for p in prodotti %}
<div class="checkout-item">
<img src="{{ url_for('static', filename=p.foto) }}" alt="{{ p.nome }}">
<div class="flex-grow-1">
<h5 class="mb-0">{{ p.nome }}</h5>
<small class="text-gold">{{ p.prezzo }}‚Ç¨</small>
</div>
</div>
            {% endfor %}

<div class="mt-4 p-3 border-top border-secondary">
<div class="d-flex justify-content-between h4">
<span>Totale:</span>
<span class="text-gold">{{ totale }}‚Ç¨</span>
</div>
                
                {% if messaggio %}
<div class="alert alert-success py-2 mt-2 small">{{ messaggio }}</div>
                {% endif %}
</div>

<form method="POST" class="mt-4">
<div class="input-group">
<input type="text" name="codice_sconto" class="form-control" placeholder="Codice Sconto (es. ALICE20, NERD69...)">
<button class="btn btn-outline-warning" type="submit">Applica</button>
</div>
<small class="text-muted d-block mt-2" style="font-size: 0.75rem;">
                    üí° Suggerimento: Hai trovato gli easter eggs? Potrebbero esserci codici nascosti...
</small>
</form>

<form action="/conferma" method="POST" class="mt-5">
<button type="submit" class="btn btn-gold w-100 py-3 fw-bold">üíé PROCEDI ALL'ORDINE</button>
</form>

<div class="text-center mt-3">
<a href="/svuota" class="text-muted small">üóëÔ∏è Svuota carrello</a>
<span class="mx-2">|</span>
<a href="/" class="text-muted small">‚Üê Continua lo shopping</a>
</div>

        {% else %}
<div class="text-center py-5">
<div style="font-size: 4rem; margin-bottom: 20px;">üõí</div>
<h3 class="text-white mb-3">Il carrello √® vuoto</h3>
<p class="text-muted">Non essere timida! Sfoglia il nostro catalogo premium.</p>
<a href="/" class="btn btn-gold mt-3">‚ú® Esplora i Gigol√≤</a>
</div>
        {% endif %}
</div>

{% if shake_enabled %}
<script>
    let lastX = null, lastY = null, lastZ = null;
    let lastShakeTime = 0;
    let clickCount = 0;
    let clickTimer = null;

    const audio = document.getElementById("fraAudio");
    const overlay = document.getElementById("audioOverlay");

    /* üîä Avvia audio + overlay */
    function playAudio() {
        audio.currentTime = 0;
        audio.play().then(() => {
            overlay.style.display = "flex";
            console.log("‚úÖ Audio avviato!");
        }).catch(err => {
            console.log("‚ùå Audio non avviato:", err);
        });
    }

    /* üßπ Nasconde overlay quando l'audio finisce */
    audio.addEventListener("ended", () => {
        overlay.style.display = "none";
    });

    /* üì± Shake detection */
    function handleMotion(event) {
        const acc = event.accelerationIncludingGravity;
        if (!acc) return;

        if (lastX === null) {
            lastX = acc.x;
            lastY = acc.y;
            lastZ = acc.z;
            return;
        }

        const deltaX = Math.abs(acc.x - lastX);
        const deltaY = Math.abs(acc.y - lastY);
        const deltaZ = Math.abs(acc.z - lastZ);

        lastX = acc.x;
        lastY = acc.y;
        lastZ = acc.z;

        const delta = deltaX + deltaY + deltaZ;

        console.log("SHAKE Œî:", delta.toFixed(2)); // DEBUG

        const now = Date.now();
        if (delta > 15 && now - lastShakeTime > 2000) {
            lastShakeTime = now;
            console.log("üéâ SHAKE RILEVATO!");
            playAudio();
            
            // Vibrazione
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }
    }

    /* üñ±Ô∏è 4 click anywhere come fallback */
    function handleClick() {
        clickCount++;

        if (clickTimer) clearTimeout(clickTimer);
        clickTimer = setTimeout(() => clickCount = 0, 1500);

        console.log("Click count:", clickCount);

        if (clickCount === 4) {
            console.log("üéâ 4 CLICK RILEVATI!");
            playAudio();
            clickCount = 0;
        }
    }

    /* üçé iOS permission */
    function requestPermission() {
        console.log("Richiedo permessi motion...");
        
        if (
            typeof DeviceMotionEvent !== "undefined" &&
            typeof DeviceMotionEvent.requestPermission === "function"
        ) {
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    console.log("Permission response:", response);
                    if (response === "granted") {
                        window.addEventListener("devicemotion", handleMotion);
                        console.log("‚úÖ Motion listener attivo (iOS)");
                    }
                })
                .catch(err => {
                    console.error("Errore permission:", err);
                });
        } else {
            // Android o browser desktop
            window.addEventListener("devicemotion", handleMotion);
            console.log("‚úÖ Motion listener attivo (Android)");
        }
    }

    // Attiva listener click
    document.addEventListener("click", handleClick);

    // Richiedi permessi al primo click
    document.body.addEventListener("click", requestPermission, { once: true });

    console.log("üéµ Script shake attivato - Fra nel carrello!");
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>