<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Checkout - GigoLove</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
</head>
{% if shake_enabled %}
<!-- Audio segreto -->
<audio id="fraAudio" src="{{ url_for('static', filename='audio/audio_serata_fra.mp3') }}"></audio>

<!-- Icona audio -->
<div id="audioOverlay">
    <div id="audioIcon">ğŸ”Š</div>
    <div id="audioText">Fra Ã¨ giÃ  in arrivoâ€¦</div>
</div>

<style>
@keyframes pulse {
    0% { transform: scale(1); opacity: 0.7; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 0.7; }
}
</style>
{% endif %}

{% if shake_enabled %}
<script>
let lastShakeTime = 0;
let clickCount = 0;
let clickTimer = null;

const SHAKE_THRESHOLD = 15;
const audio = document.getElementById("fraAudio");
const overlay = document.getElementById("audioOverlay");

/* ğŸ”Š Avvia audio + overlay */
function playAudio() {
    audio.currentTime = 0;
    audio.play().then(() => {
        overlay.style.display = "flex";
    }).catch(err => {
        console.log("Audio non avviato:", err);
    });
}

/* ğŸ§¹ Nasconde overlay quando lâ€™audio finisce */
audio.addEventListener("ended", () => {
    overlay.style.display = "none";
});

/* ğŸ“± Shake detection */
function handleMotion(event) {
    const acc = event.accelerationIncludingGravity;
    if (!acc) return;

    const magnitude = Math.sqrt(
        acc.x * acc.x +
        acc.y * acc.y +
        acc.z * acc.z
    );

    const now = Date.now();
    if (magnitude > SHAKE_THRESHOLD && now - lastShakeTime > 2000) {
        lastShakeTime = now;
        playAudio();
    }
}

/* ğŸ–±ï¸ 4 click anywhere */
function handleClick() {
    clickCount++;

    if (clickTimer) clearTimeout(clickTimer);
    clickTimer = setTimeout(() => clickCount = 0, 1500);

    if (clickCount === 4) {
        playAudio();
        clickCount = 0;
    }
}

/* ğŸ iOS permission */
function requestPermission() {
    if (
        typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function"
    ) {
        DeviceMotionEvent.requestPermission().then(response => {
            if (response === "granted") {
                window.addEventListener("devicemotion", handleMotion);
            }
        });
    } else {
        window.addEventListener("devicemotion", handleMotion);
    }
}

document.addEventListener("click", handleClick);
document.body.addEventListener("click", requestPermission, { once: true });
</script>
{% endif %}



<body class="bg-black text-white">
<div class="container py-5">
<h1 class="luxury-text text-center mb-4">ğŸ›’ Il tuo Carrello</h1>
        
        {% if prodotti %}
            {% for p in prodotti %}
<div class="checkout-item">
<img src="{{ url_for('static', filename=p.foto) }}" alt="{{ p.nome }}">
<div class="flex-grow-1">
<h5 class="mb-0">{{ p.nome }}</h5>
<small class="text-gold">{{ p.prezzo }}â‚¬</small>
</div>
</div>
            {% endfor %}

<div class="mt-4 p-3 border-top border-secondary">
<div class="d-flex justify-content-between h4">
<span>Totale:</span>
<span class="text-gold">{{ totale }}â‚¬</span>
</div>
                
                {% if messaggio %}
<div class="alert alert-success py-2 mt-2 small">{{ messaggio }}</div>
                {% endif %}
</div>

<form method="POST" class="mt-4">
<div class="input-group">
<input type="text" name="codice_sconto" class="form-control" placeholder="Codice Sconto (es. ALICE20, NERD69...)">
<button class="btn btn-outline-warning" type="submit">Applica</button>
</div>
<small class="text-muted d-block mt-2" style="font-size: 0.75rem;">
                    ğŸ’¡ Suggerimento: Hai trovato gli easter eggs? Potrebbero esserci codici nascosti...
</small>
</form>

<form action="/conferma" method="POST" class="mt-5">
<button type="submit" class="btn btn-gold w-100 py-3 fw-bold">ğŸ’ PROCEDI ALL'ORDINE</button>
</form>

<div class="text-center mt-3">
<a href="/svuota" class="text-muted small">ğŸ—‘ï¸ Svuota carrello</a>
<span class="mx-2">|</span>
<a href="/" class="text-muted small">â† Continua lo shopping</a>
</div>

        {% else %}
<div class="text-center py-5">
<div style="font-size: 4rem; margin-bottom: 20px;">ğŸ›’</div>
<h3 class="text-white mb-3">Il carrello Ã¨ vuoto</h3>
<p class="text-muted">Non essere timida! Sfoglia il nostro catalogo premium.</p>
<a href="/" class="btn btn-gold mt-3">âœ¨ Esplora i GigolÃ²</a>
</div>
        {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>