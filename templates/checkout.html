<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Checkout - GigoLove</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">

{% if shake_enabled %}
<style>
    /* Audio Icon Floating */
    #audioIcon {
        position: fixed;
        bottom: 30px;
        right: 30px;
        font-size: 5rem;
        z-index: 10000;
        animation: float 2s ease-in-out infinite;
        display: none;
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
    }

    #audioIcon.show {
        display: block;
    }

    #audioIcon.playing {
        animation: spin 2s linear infinite, pulse 1.5s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    @keyframes pulse {
        0%, 100% { 
            transform: scale(1);
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
        }
        50% { 
            transform: scale(1.3);
            filter: drop-shadow(0 0 40px rgba(255, 215, 0, 1));
        }
    }
</style>
{% endif %}
</head>

<body class="bg-black text-white">

{% if shake_enabled %}
<!-- Audio Element -->
<audio id="fraAudio" preload="auto">
<source src="{{ url_for('static', filename='audio/audio_serata_fra.mp3') }}" type="audio/mpeg">
</audio>

<!-- Simple Audio Icon -->
<div id="audioIcon">üîä</div>
{% endif %}

<div class="container py-5">
<h1 class="luxury-text text-center mb-4">üõí Il tuo Carrello</h1>
        
        {% if prodotti %}
            {% for p in prodotti %}
<div class="checkout-item">
<img src="{{ url_for('static', filename=p.foto) }}" alt="{{ p.nome }}">
<div class="flex-grow-1">
<h5 class="mb-0">{{ p.nome }}</h5>
<small class="text-gold">{{ p.prezzo }}‚Ç¨</small>
</div>
</div>
            {% endfor %}

<div class="mt-4 p-3 border-top border-secondary">
<div class="d-flex justify-content-between h4">
<span>Totale:</span>
<span class="text-gold">{{ totale }}‚Ç¨</span>
</div>
                
                {% if messaggio %}
<div class="alert alert-success py-2 mt-2 small">{{ messaggio }}</div>
                {% endif %}
</div>

<form method="POST" class="mt-4" id="discountForm">
<div class="input-group">
<input type="text" name="codice_sconto" id="discountInput" class="form-control" placeholder="Codice Sconto (es. ALICE20{% if shake_enabled %}, TWERK{% endif %}...)">
<button class="btn btn-outline-warning" type="submit">Applica</button>
</div>
<small class="text-muted d-block mt-2" style="font-size: 0.75rem;">
                    üí° Suggerimento: Hai trovato gli easter eggs? Potrebbero esserci codici nascosti...
</small>
</form>

<form action="/conferma" method="POST" class="mt-5">
<button type="submit" class="btn btn-gold w-100 py-3 fw-bold">üíé PROCEDI ALL'ORDINE</button>
</form>

<div class="text-center mt-3">
<a href="/svuota" class="text-muted small">üóëÔ∏è Svuota carrello</a>
<span class="mx-2">|</span>
<a href="/" class="text-muted small">‚Üê Continua lo shopping</a>
</div>

        {% else %}
<div class="text-center py-5">
<div style="font-size: 4rem; margin-bottom: 20px;">üõí</div>
<h3 class="text-white mb-3">Il carrello √® vuoto</h3>
<p class="text-muted">Non essere timida! Sfoglia il nostro catalogo premium.</p>
<a href="/" class="btn btn-gold mt-3">‚ú® Esplora i Gigol√≤</a>
</div>
        {% endif %}
</div>

{% if shake_enabled %}
<script>
    console.log("üéµ SHAKE EASTER EGG LOADED!");
    
    const audio = document.getElementById("fraAudio");
    const audioIcon = document.getElementById("audioIcon");
    const discountForm = document.getElementById("discountForm");
    const discountInput = document.getElementById("discountInput");

    let isListening = false;
    let lastShakeTime = 0;
    let shakeCount = 0;

    // Variabili per accelerometro
    let lastX = 0;
    let lastY = 0;
    let lastZ = 0;
    let isFirstReading = true;

    /* ==================== PLAY AUDIO ==================== */
    function playAudio() {
        console.log("üîä AUDIO WILL START IN 3 SECONDS...");
        
        // Mostra icona SUBITO
        audioIcon.classList.add("show");
        audioIcon.classList.add("playing");
        
        // Vibrazione iniziale
        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
        }
        
        // ASPETTA 3 SECONDI PRIMA DI PARTIRE
        setTimeout(() => {
            console.log("üéµ PLAYING AUDIO NOW!");
            audio.currentTime = 0;
            
            audio.play()
                .then(() => {
                    console.log("‚úÖ Audio started successfully!");
                    
                    // Vibrazione quando parte davvero
                    if (navigator.vibrate) {
                        navigator.vibrate([300, 100, 300]);
                    }
                })
                .catch(err => {
                    console.error("‚ùå Audio play failed:", err);
                    audioIcon.classList.remove("playing");
                    audioIcon.classList.remove("show");
                });
        }, 3000); // 3 secondi di delay
    }

    /* ==================== SHAKE DETECTION ==================== */
    function handleMotionEvent(event) {
        if (!isListening) return;

        const acc = event.accelerationIncludingGravity;
        if (!acc || acc.x === null) return;

        const x = acc.x || 0;
        const y = acc.y || 0;
        const z = acc.z || 0;

        if (isFirstReading) {
            lastX = x;
            lastY = y;
            lastZ = z;
            isFirstReading = false;
            return;
        }

        const deltaX = Math.abs(x - lastX);
        const deltaY = Math.abs(y - lastY);
        const deltaZ = Math.abs(z - lastZ);
        const totalDelta = deltaX + deltaY + deltaZ;

        lastX = x;
        lastY = y;
        lastZ = z;

        // SOGLIA PI√ô ALTA: 25 invece di 12 (serve pi√π energia!)
        const now = Date.now();
        if (totalDelta > 25) {
            shakeCount++;
            console.log("üåü STRONG SHAKE! Count:", shakeCount, "Delta:", totalDelta.toFixed(2));
            
            // Servono 3 shake forti in 1.5 secondi
            if (shakeCount >= 3 && now - lastShakeTime < 1500) {
                console.log("üéâüéâüéâ SHAKE THRESHOLD REACHED! PLAYING AUDIO!");
                playAudio();
                shakeCount = 0;
            }
            
            lastShakeTime = now;
        }

        // Reset shake count dopo 1.5 secondi
        if (now - lastShakeTime > 1500) {
            shakeCount = 0;
        }
    }

    /* ==================== ACTIVATE SHAKE VIA CODE ==================== */
    discountForm.addEventListener("submit", (e) => {
        const code = discountInput.value.trim().toUpperCase();
        
        if (code === "TWERK") {
            e.preventDefault(); // Blocca submit
            
            console.log("üéØ TWERK code entered!");
            
            // iOS permission request
            if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
                console.log("üì± iOS - requesting permission");
                
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        console.log("‚úÖ Permission:", response);
                        
                        if (response === "granted") {
                            console.log("üéâ PERMISSION GRANTED!");
                            isListening = true;
                            window.addEventListener("devicemotion", handleMotionEvent);
                            
                            // Feedback visivo
                            discountInput.value = "";
                            discountInput.placeholder = "‚úÖ Twerk attivato! Scuoti il telefono!";
                            discountInput.style.borderColor = "#FFD700";
                            
                            setTimeout(() => {
                                discountInput.placeholder = "Codice Sconto (es. ALICE20, TWERK...)";
                                discountInput.style.borderColor = "";
                            }, 3000);
                        } else {
                            alert("Permesso negato!");
                        }
                    })
                    .catch(err => {
                        console.error("‚ùå Error:", err);
                        alert("Errore: " + err.message);
                    });
            } else {
                // Android
                console.log("üì± Android - activating");
                isListening = true;
                window.addEventListener("devicemotion", handleMotionEvent);
                
                discountInput.value = "";
                discountInput.placeholder = "‚úÖ Twerk attivato! Scuoti il telefono!";
                discountInput.style.borderColor = "#FFD700";
                
                setTimeout(() => {
                    discountInput.placeholder = "Codice Sconto (es. ALICE20, TWERK...)";
                    discountInput.style.borderColor = "";
                }, 3000);
            }
        }
    });

    /* ==================== AUDIO END ==================== */
    audio.addEventListener("ended", () => {
        audioIcon.classList.remove("playing");
        audioIcon.classList.remove("show");
    });

    // Click sull'icona per fermare
    audioIcon.addEventListener("click", () => {
        audio.pause();
        audio.currentTime = 0;
        audioIcon.classList.remove("playing");
        audioIcon.classList.remove("show");
    });

    console.log("‚úÖ Script ready - insert code TWERK to activate!");
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>